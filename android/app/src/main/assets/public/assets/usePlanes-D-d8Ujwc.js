import{r as u,l as w,s as c}from"./index-C_D-5Bfv.js";function q(){const[k,p]=u.useState([]),[f,_]=u.useState(!0),{toast:o}=w(),d=u.useCallback(async()=>{try{_(!0);const{data:r,error:e}=await c.from("planes_mantenimiento").select("*").order("nombre");if(e)throw e;const{data:a,error:t}=await c.from("plan_intervalos").select("*").order("orden");if(t)throw t;const{data:i,error:n}=await c.from("plan_intervalo_kits").select("id, plan_intervalo_id, kit_id, created_at, kits_mantenimiento(*, kit_piezas(*))");if(n)throw n;const v=(i||[]).filter(s=>!!s.kits_mantenimiento).map(s=>{const l=s.kits_mantenimiento;return l&&l.kit_piezas&&(l.piezas=l.kit_piezas,delete l.kit_piezas),{id:s.id,plan_intervalo_id:s.plan_intervalo_id,kit_id:s.kit_id,created_at:s.created_at,kit:l}}),m=(r||[]).map(s=>({...s,intervalos:(a||[]).filter(l=>l.plan_id===s.id).map(l=>({...l,tareas:Array.isArray(l.tareas)?l.tareas:[],kits:v.filter(h=>h.plan_intervalo_id===l.id)}))}));p(m)}catch(r){console.error("Error loading plans:",r),o({title:"Error",description:"No se pudieron cargar los planes de mantenimiento",variant:"destructive"})}finally{_(!1)}},[o]);return u.useEffect(()=>{d();const r=c.channel("planes-changes").on("postgres_changes",{event:"*",schema:"public",table:"planes_mantenimiento"},()=>d()).on("postgres_changes",{event:"*",schema:"public",table:"plan_intervalos"},()=>d()).on("postgres_changes",{event:"*",schema:"public",table:"plan_intervalo_kits"},()=>d()).subscribe();return()=>{c.removeChannel(r)}},[d]),{planes:k,loading:f,createPlan:async r=>{try{const{data:e,error:a}=await c.from("planes_mantenimiento").insert([r]).select().single();if(a)throw a;const t={...e,intervalos:[]};return p(i=>[...i,t].sort((n,v)=>n.nombre.localeCompare(v.nombre))),o({title:"Plan creado",description:"El plan de mantenimiento se creó correctamente"}),e}catch(e){throw console.error("Error creating plan:",e),o({title:"Error",description:"No se pudo crear el plan",variant:"destructive"}),e}},updatePlan:async(r,e)=>{try{p(t=>t.map(i=>i.id===r?{...i,...e}:i).sort((i,n)=>i.nombre.localeCompare(n.nombre)));const{error:a}=await c.from("planes_mantenimiento").update(e).eq("id",r);if(a)throw await d(),a;o({title:"Plan actualizado",description:"El plan se actualizó correctamente"})}catch(a){throw console.error("Error updating plan:",a),o({title:"Error",description:"No se pudo actualizar el plan",variant:"destructive"}),a}},deletePlan:async r=>{try{p(a=>a.filter(t=>t.id!==r));const{error:e}=await c.from("planes_mantenimiento").delete().eq("id",r);if(e)throw await d(),e;o({title:"Plan eliminado",description:"El plan se eliminó correctamente"})}catch(e){throw console.error("Error deleting plan:",e),o({title:"Error",description:"No se pudo eliminar el plan",variant:"destructive"}),e}},createIntervalo:async r=>{try{const{data:e,error:a}=await c.from("plan_intervalos").insert([r]).select().single();if(a)throw a;return p(t=>t.map(i=>{if(i.id===r.plan_id){const n={...e,tareas:Array.isArray(e.tareas)?e.tareas:[],kits:[]};return{...i,intervalos:[...i.intervalos,n].sort((v,m)=>v.orden-m.orden)}}return i})),o({title:"Intervalo creado",description:"El intervalo se agregó al plan"}),e}catch(e){throw console.error("Error creating interval:",e),o({title:"Error",description:"No se pudo crear el intervalo",variant:"destructive"}),e}},updateIntervalo:async(r,e)=>{try{p(t=>t.map(i=>({...i,intervalos:i.intervalos.map(n=>n.id===r?{...n,...e}:n).sort((n,v)=>n.orden-v.orden)})));const{error:a}=await c.from("plan_intervalos").update(e).eq("id",r);if(a)throw await d(),a;o({title:"Intervalo actualizado",description:"El intervalo se actualizó correctamente"})}catch(a){throw console.error("Error updating interval:",a),o({title:"Error",description:"No se pudo actualizar el intervalo",variant:"destructive"}),a}},deleteIntervalo:async r=>{try{p(a=>a.map(t=>({...t,intervalos:t.intervalos.filter(i=>i.id!==r)})));const{error:e}=await c.from("plan_intervalos").delete().eq("id",r);if(e)throw await d(),e;o({title:"Intervalo eliminado",description:"El intervalo se eliminó correctamente"})}catch(e){throw console.error("Error deleting interval:",e),o({title:"Error",description:"No se pudo eliminar el intervalo",variant:"destructive"}),e}},refreshPlanes:d,linkKitToInterval:async(r,e)=>{var a;try{const{data:t,error:i}=await c.from("plan_intervalo_kits").insert({plan_intervalo_id:r,kit_id:e}).select("*, kits_mantenimiento(*, kit_piezas(*))").single();if(i)throw i;if(t&&t.kits_mantenimiento){const n=t.kits_mantenimiento;n.kit_piezas&&(n.piezas=n.kit_piezas,delete n.kit_piezas),p(v=>v.map(m=>({...m,intervalos:m.intervalos.map(s=>s.id===r?{...s,kits:[...s.kits,{id:t.id,plan_intervalo_id:t.plan_intervalo_id,kit_id:t.kit_id,created_at:t.created_at,kit:n}]}:s)})))}o({title:"Kit asignado",description:"El kit se vinculó al intervalo correctamente."})}catch(t){throw await d(),console.error("Error linking kit:",t),o({title:"Error",description:(a=t.message)!=null&&a.includes("duplicate")?"El kit ya est�� asignado a este intervalo":"No se pudo asignar el kit al intervalo",variant:"destructive"}),t}},unlinkKitFromInterval:async r=>{try{p(a=>a.map(t=>({...t,intervalos:t.intervalos.map(i=>({...i,kits:i.kits.filter(n=>n.id!==r)}))})));const{error:e}=await c.from("plan_intervalo_kits").delete().eq("id",r);if(e)throw await d(),e;o({title:"Kit eliminado",description:"El kit se desvinculó del intervalo."})}catch(e){throw console.error("Error removing kit:",e),o({title:"Error",description:"No se pudo remover el kit del intervalo",variant:"destructive"}),e}}}}export{q as u};
