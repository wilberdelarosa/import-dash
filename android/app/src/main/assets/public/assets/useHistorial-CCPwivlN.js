import{r as s,s as p,v as _}from"./index-C_D-5Bfv.js";const g=23,b=59,v=59,D=999,f={crear:"Creación",actualizar:"Actualización",eliminar:"Eliminación",mantenimiento_realizado:"Mantenimiento realizado",stock_movido:"Movimiento de stock",lectura_actualizada:"Lectura actualizada",sistema:"Sistema"},w={equipo_creado:{categoria:"crear",etiqueta:"Equipo creado"},equipo_actualizado:{categoria:"actualizar",etiqueta:"Equipo actualizado"},equipo_eliminado:{categoria:"eliminar",etiqueta:"Equipo eliminado"},inventario_creado:{categoria:"crear",etiqueta:"Inventario creado"},inventario_actualizado:{categoria:"actualizar",etiqueta:"Inventario actualizado"},inventario_eliminado:{categoria:"eliminar",etiqueta:"Inventario eliminado"},mantenimiento_creado:{categoria:"crear",etiqueta:"Mantenimiento creado"},mantenimiento_actualizado:{categoria:"actualizar",etiqueta:"Mantenimiento actualizado"},mantenimiento_eliminado:{categoria:"eliminar",etiqueta:"Mantenimiento eliminado"},importacion_sincronizada:{categoria:"sistema",etiqueta:"Importación sincronizada"}},H=o=>o.split(/[_\s]+/).filter(Boolean).map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join(" "),O=o=>Object.prototype.hasOwnProperty.call(f,o),N=o=>{if(O(o))return{categoria:o,etiquetaCategoria:f[o],etiquetaSubtipo:null};const r=w[o];return r?{categoria:r.categoria,etiquetaCategoria:f[r.categoria],etiquetaSubtipo:r.etiqueta}:{categoria:"sistema",etiquetaCategoria:f.sistema,etiquetaSubtipo:H(o)}},y=o=>{if(!o)return null;const r=new Date(o);return Number.isNaN(r.getTime())?null:r};function F(){const[o,r]=s.useState([]),[S,h]=s.useState(!0),[e,z]=s.useState({busqueda:"",tipoEvento:[],modulo:[],nivelImportancia:[],fichaEquipo:null,fechaDesde:null,fechaHasta:null}),E=s.useCallback(a=>{const n=e.busqueda.trim().toLowerCase(),c=e.fechaDesde?new Date(e.fechaDesde):null,l=e.fechaHasta?new Date(e.fechaHasta):null;return c&&c.setHours(0,0,0,0),l&&l.setHours(g,b,v,D),a.filter(i=>{if(e.tipoEvento.length>0&&!e.tipoEvento.includes(i.categoriaEvento)||e.modulo.length>0&&!e.modulo.includes(i.modulo)||e.nivelImportancia.length>0&&!e.nivelImportancia.includes(i.nivelImportancia)||e.fichaEquipo&&(!i.fichaEquipo||i.fichaEquipo.toLowerCase()!==e.fichaEquipo.toLowerCase()))return!1;const t=y(i.createdAt);return c&&t&&t<c||l&&t&&t>l?!1:n?[i.descripcion,i.fichaEquipo,i.nombreEquipo,i.usuarioResponsable,i.etiquetaCategoria,i.etiquetaSubtipo,i.tipoEvento].filter(Boolean).some(d=>d==null?void 0:d.toLowerCase().includes(n)):!0})},[e]),u=s.useCallback(async()=>{try{h(!0);let a=p.from("historial_eventos").select("*").order("created_at",{ascending:!1});if(e.modulo.length>0&&(a=a.in("modulo",e.modulo)),e.nivelImportancia.length>0&&(a=a.in("nivel_importancia",e.nivelImportancia)),e.fichaEquipo&&(a=a.eq("ficha_equipo",e.fichaEquipo)),e.fechaDesde&&(a=a.gte("created_at",e.fechaDesde.toISOString())),e.fechaHasta){const t=new Date(e.fechaHasta);t.setHours(g,b,v,D),a=a.lte("created_at",t.toISOString())}const{data:n,error:c}=await a;if(c)throw c;const l=(n||[]).map(t=>{const q=t.tipo_evento??"sistema",{categoria:d,etiquetaCategoria:C,etiquetaSubtipo:I}=N(t.tipo_evento??"sistema");return{id:Number(t.id),tipoEvento:q,categoriaEvento:d,etiquetaCategoria:C,etiquetaSubtipo:I,modulo:t.modulo,fichaEquipo:t.ficha_equipo,nombreEquipo:t.nombre_equipo,usuarioResponsable:t.usuario_responsable,descripcion:t.descripcion,datosAntes:t.datos_antes,datosDespues:t.datos_despues,nivelImportancia:t.nivel_importancia,metadata:t.metadata,createdAt:t.created_at}}),i=E(l);r(i)}catch(a){console.error("Error loading eventos:",a),_({title:"Error",description:"No se pudieron cargar los eventos del historial",variant:"destructive"}),r([])}finally{h(!1)}},[E,e]),m=s.useRef();return s.useEffect(()=>{m.current=u},[u]),s.useEffect(()=>{u()},[u]),s.useEffect(()=>{const a=p.channel("historial-changes").on("postgres_changes",{event:"*",schema:"public",table:"historial_eventos"},()=>{var n;(n=m.current)==null||n.call(m)}).subscribe();return()=>{p.removeChannel(a)}},[]),{eventos:o,loading:S,filtros:e,setFiltros:z,loadEventos:u,registrarEvento:async a=>{try{const{error:n}=await p.from("historial_eventos").insert({tipo_evento:a.tipoEvento,modulo:a.modulo,ficha_equipo:a.fichaEquipo,nombre_equipo:a.nombreEquipo,usuario_responsable:a.usuarioResponsable,descripcion:a.descripcion,datos_antes:a.datosAntes,datos_despues:a.datosDespues,nivel_importancia:a.nivelImportancia,metadata:a.metadata});if(n)throw n}catch(n){console.error("Error registering event:",n)}},limpiarHistorial:async()=>{try{const{error:a}=await p.from("historial_eventos").delete().neq("id",0);if(a)throw a;_({title:"✅ Historial limpiado",description:"Todos los eventos fueron eliminados"}),await u()}catch(a){console.error("Error clearing historial:",a),_({title:"❌ Error",description:"No se pudo limpiar el historial",variant:"destructive"})}}}}export{F as u};
