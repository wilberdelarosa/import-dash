import{c as Ze,r as t,l as Pe,s as N,b as Ie,j as e,a as O,m as We,X as Oe}from"./index-C_D-5Bfv.js";import{B as h,W as oe,t as ce,L as Xe,g as K,h as Z,y as Ye,k as ee,l as se,S as ge,j as U,z as Je,$ as te,P as he,w as fe,D as je,o as be,p as ve,q as Ne,F as we,G as ye,Z as Qe}from"./card-BIr-PJK2.js";import{u as He}from"./usePlanes-D-d8Ujwc.js";import{u as es}from"./useKits-BJbO5bSf.js";import{B as L}from"./index-BtotK06U.js";import{I as Me}from"./input-DSUZcGci.js";import{L as W}from"./label-CqFCS6R-.js";import{S as ze,a as Re,b as qe,c as Le,d as ie}from"./select-3Jn5ARjr.js";import{T as ss}from"./textarea-BSj91dWz.js";import{u as as}from"./useDeviceDetection-CShWnkOv.js";import{M as De,Z as rs}from"./MobileLayout-CV04gzFk.js";import{M as ae}from"./MobileCard-DMSzGukU.js";import{T as Ke}from"./trending-up-Hw4Rtp_f.js";import{C as ne}from"./circle-check-DUwGofyK.js";import{F as ts}from"./filter-ldW4984T.js";import{C as Te}from"./chevron-right-fj5H7AOZ.js";import{M as is,G as ns}from"./map-pinned-C15isc_R.js";import{S as Fe}from"./sparkles-CBL8q4dG.js";import{S as $e}from"./square-pen-B3pUQB5y.js";import{C as ls}from"./clock-Chbx4_2l.js";import{f as os}from"./format-B1dMESlT.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=Ze("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);function ds(){const[j,_]=t.useState([]),[z,B]=t.useState([]),[P,w]=t.useState([]),[g,b]=t.useState([]),[C,p]=t.useState([]),[F,k]=t.useState(!0),{toast:v}=Pe(),o=t.useCallback(async()=>{try{const{data:c,error:l}=await N.from("planificaciones_mantenimiento").select("*").order("created_at",{ascending:!1});if(l)throw l;_(c||[])}catch(c){console.error("Error loading planificaciones:",c)}},[]),A=t.useCallback(async()=>{try{const{data:c,error:l}=await N.from("alertas_mantenimiento").select("*").order("created_at",{ascending:!1});if(l)throw l;B(c||[])}catch(c){console.error("Error loading alertas:",c)}},[]),$=t.useCallback(async()=>{try{const{data:c,error:l}=await N.from("equipos_planes_auto").select("*").order("modelo");if(l)throw l;w(c||[])}catch(c){console.error("Error loading equipos_planes_auto:",c)}},[]),f=t.useCallback(async()=>{try{const{data:c,error:l}=await N.from("equipos_con_planes_sugeridos").select("*").order("nombre");if(l)throw l;b(c||[])}catch(c){console.error("Error loading equipos_con_planes:",c)}},[]),i=t.useCallback(async()=>{try{const{data:c,error:l}=await N.rpc("get_equipos_requieren_alerta");if(l)throw l;p(c||[])}catch(c){console.error("Error loading equipos que requieren alerta:",c)}},[]),m=t.useCallback(async()=>{k(!0),await Promise.all([o(),A(),$(),f(),i()]),k(!1)},[o,A,$,f,i]);return t.useEffect(()=>{m();const c=N.channel("planificacion-changes").on("postgres_changes",{event:"*",schema:"public",table:"planificaciones_mantenimiento"},()=>o()).on("postgres_changes",{event:"*",schema:"public",table:"alertas_mantenimiento"},()=>{A(),i()}).on("postgres_changes",{event:"*",schema:"public",table:"equipos_planes_auto"},()=>{$(),f()}).subscribe();return()=>{N.removeChannel(c)}},[m,o,A,$,f,i]),{planificaciones:j,alertas:z,equiposPlanesAuto:P,equiposConPlanes:g,equiposRequierenAlerta:C,loading:F,crearPlanificacion:async c=>{try{const{data:l,error:u}=await N.from("planificaciones_mantenimiento").insert([c]).select().single();if(u)throw u;return v({title:"âœ… PlanificaciÃ³n creada",description:`${c.nombreEquipo} - ${c.proximoMP}`}),l}catch(l){throw console.error("Error creating planificacion:",l),v({title:"Error",description:"No se pudo crear la planificaciÃ³n",variant:"destructive"}),l}},actualizarPlanificacion:async(c,l)=>{try{const{error:u}=await N.from("planificaciones_mantenimiento").update(l).eq("id",c);if(u)throw u;v({title:"PlanificaciÃ³n actualizada",description:"Los cambios se guardaron correctamente"})}catch(u){throw console.error("Error updating planificacion:",u),v({title:"Error",description:"No se pudo actualizar la planificaciÃ³n",variant:"destructive"}),u}},eliminarPlanificacion:async c=>{try{const{error:l}=await N.from("planificaciones_mantenimiento").delete().eq("id",c);if(l)throw l;v({title:"PlanificaciÃ³n eliminada",description:"La planificaciÃ³n se eliminÃ³ correctamente"})}catch(l){throw console.error("Error deleting planificacion:",l),v({title:"Error",description:"No se pudo eliminar la planificaciÃ³n",variant:"destructive"}),l}},crearAlerta:async c=>{var l;try{const{data:u,error:X}=await N.from("alertas_mantenimiento").insert([c]).select().single();if(X)throw X;return v({title:"Alerta configurada",description:`Se alertarÃ¡ ${c.horas_alerta}h antes para ${c.nombre_equipo}`}),u}catch(u){throw console.error("Error creating alerta:",u),v({title:"Error",description:(l=u.message)!=null&&l.includes("duplicate")?"Ya existe una alerta para este equipo e intervalo":"No se pudo crear la alerta",variant:"destructive"}),u}},actualizarAlerta:async(c,l)=>{try{const{error:u}=await N.from("alertas_mantenimiento").update(l).eq("id",c);if(u)throw u;v({title:"Alerta actualizada",description:"La configuraciÃ³n se actualizÃ³ correctamente"})}catch(u){throw console.error("Error updating alerta:",u),v({title:"Error",description:"No se pudo actualizar la alerta",variant:"destructive"}),u}},eliminarAlerta:async c=>{try{const{error:l}=await N.from("alertas_mantenimiento").delete().eq("id",c);if(l)throw l;v({title:"Alerta eliminada",description:"La alerta se eliminÃ³ correctamente"})}catch(l){throw console.error("Error deleting alerta:",l),v({title:"Error",description:"No se pudo eliminar la alerta",variant:"destructive"}),l}},asociarPlanAModelo:async(c,l,u,X)=>{var re;try{const{data:Y,error:n}=await N.from("equipos_planes_auto").insert([{modelo:c,marca:l,plan_id:u,categoria:X}]).select().single();if(n)throw n;return v({title:"Plan asociado",description:`Todos los ${c} ${l} usarÃ¡n este plan automÃ¡ticamente`}),await N.rpc("refresh_equipos_planes_sugeridos"),Y}catch(Y){throw console.error("Error asociando plan:",Y),v({title:"Error",description:(re=Y.message)!=null&&re.includes("duplicate")?"Este modelo ya tiene ese plan asignado":"No se pudo asociar el plan",variant:"destructive"}),Y}},desasociarPlanDeModelo:async c=>{try{const{error:l}=await N.from("equipos_planes_auto").delete().eq("id",c);if(l)throw l;v({title:"AsociaciÃ³n eliminada",description:"El plan se desvinculÃ³ del modelo"}),await N.rpc("refresh_equipos_planes_sugeridos")}catch(l){throw console.error("Error desasociando plan:",l),v({title:"Error",description:"No se pudo eliminar la asociaciÃ³n",variant:"destructive"}),l}},refreshPlanificaciones:o,refreshAlertas:A,refreshAll:m}}function ms(j,_){const{planes:z}=He(),{crearPlanificacion:B}=ds(),{data:P}=Ie(),w=t.useMemo(()=>P.equipos.find(f=>f.ficha===j),[P.equipos,j]),g=t.useMemo(()=>_&&z.find(f=>f.id===_)||null,[z,_]),b=t.useMemo(()=>0,[w]),C=t.useMemo(()=>"HORAS",[w]),p=t.useMemo(()=>{if(!g||!w||g.intervalos.length===0)return[];const f=[];let i=b;const m=[...g.intervalos].sort((x,y)=>x.orden-y.orden);for(let x=0;x<8;x++){const y=x%m.length,M=m[y],D=Math.floor(x/m.length)+1;i+=M.horas_intervalo||0;const G=M.kits&&M.kits.length>0?M.kits[0].kit:null;f.push({orden:x+1,mp:M.codigo,nombre:M.nombre,horasObjetivo:i,horasActuales:b,horasRestantes:i-b,ciclo:D,intervaloId:M.id,kitId:(G==null?void 0:G.id)||null,kitNombre:(G==null?void 0:G.nombre)||null,tareas:Array.isArray(M.tareas)?M.tareas:[]})}return f},[g,w,b]),F=t.useMemo(()=>{if(p.length===0||!g)return[];const f=g.intervalos.length,i=Math.ceil(p.length/f),m=[];for(let x=1;x<=i;x++){const y=p.filter(M=>M.ciclo===x);y.length>0&&m.push({numero:x,inicio:y[0].horasObjetivo,fin:y[y.length-1].horasObjetivo,intervalos:y,completo:y.length===f})}return m},[p,g]),k=t.useMemo(()=>p.length>0?p[0]:null,[p]),v=async(f=p,i)=>{if(!w||!g)throw new Error("Equipo o plan no disponibles");const m=f.map(x=>{const y={fichaEquipo:w.ficha,nombreEquipo:w.nombre,categoria:w.categoria,marca:w.marca||g.marca,modelo:w.modelo||g.modelo||"",lecturasActuales:x.horasActuales,proximoMP:x.mp,proximasHoras:x.horasObjetivo,horasRestantes:x.horasRestantes,planId:g.id,intervaloId:x.intervaloId,kitId:x.kitId,planNombre:g.nombre,kitNombre:x.kitNombre||void 0,estado:"pendiente",observaciones:`Ciclo ${x.ciclo} - ${x.nombre}`,tecnico_responsable:i==null?void 0:i.tecnicoResponsable,horas_alerta:(i==null?void 0:i.horasAlerta)||50,...x.orden&&{numero_ruta:x.orden},...x.ciclo&&{ciclo_numero:x.ciclo},...(i==null?void 0:i.esOverride)!==void 0&&{es_override:i.esOverride}};return B(y)});await Promise.all(m)},o=t.useMemo(()=>!!(g&&g.intervalos&&g.intervalos.length>0),[g]),A=t.useMemo(()=>p.length===0?0:p[p.length-1].horasObjetivo-b,[p,b]),$=t.useMemo(()=>({totalRutas:p.length,totalCiclos:F.length,horasTotal:A,rutasCriticas:p.filter(f=>f.horasRestantes<100).length,rutasUrgentes:p.filter(f=>f.horasRestantes<50).length,proximoMP:(k==null?void 0:k.mp)||null,horasHastaProximo:(k==null?void 0:k.horasRestantes)||0}),[p,F,A,k]);return{rutas:p,ciclos:F,proximoMantenimiento:k,equipo:w,plan:g,lecturasActuales:b,unidadMedida:C,planValido:o,estadisticas:$,totalHorasRutas:A,guardarRutas:v}}function xs(){const[j,_]=t.useState([]),[z,B]=t.useState([]),[P,w]=t.useState(!0),{toast:g}=Pe(),b=t.useCallback(async()=>{try{const{data:i,error:m}=await N.from("overrides_planes").select("*").order("created_at",{ascending:!1});if(m)throw m;_(i||[])}catch(i){console.error("Error loading overrides:",i)}},[]),C=t.useCallback(async()=>{try{const{data:i,error:m}=await N.from("equipos_con_overrides").select("*").order("override_fecha",{ascending:!1});if(m)throw m;B(i||[])}catch(i){console.error("Error loading equipos con override:",i)}},[]);t.useEffect(()=>{(async()=>{w(!0),await Promise.all([b(),C()]),w(!1)})()},[b,C]),t.useEffect(()=>{const i=N.channel("overrides-changes").on("postgres_changes",{event:"*",schema:"public",table:"overrides_planes"},()=>{b(),C()}).subscribe();return()=>{N.removeChannel(i)}},[b,C]);const p=async i=>{try{const m={id:-Date.now(),ficha_equipo:i.ficha_equipo,plan_original_id:i.plan_original_id||null,plan_forzado_id:i.plan_forzado_id,motivo:i.motivo,usuario_email:i.usuario_email,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),activo:!0};_(M=>[m,...M]);const{data:x,error:y}=await N.from("overrides_planes").insert([i]).select().single();if(y)throw await b(),y;return _(M=>M.map(D=>D.id===m.id?x:D)),g({title:"âœ… Override creado",description:`Plan manual asignado a equipo ${i.ficha_equipo}`}),x}catch(m){throw console.error("Error creating override:",m),g({title:"âŒ Error",description:"No se pudo crear el override",variant:"destructive"}),m}},F=async(i,m)=>{try{_(M=>M.map(D=>D.id===i?{...D,...m,updated_at:new Date().toISOString()}:D));const{data:x,error:y}=await N.from("overrides_planes").update(m).eq("id",i).select().single();if(y)throw await b(),y;return g({title:"âœ… Override actualizado",description:"Cambios guardados correctamente"}),x}catch(x){throw console.error("Error updating override:",x),g({title:"âŒ Error",description:"No se pudo actualizar el override",variant:"destructive"}),x}},k=async i=>{try{await F(i,{activo:!1}),g({title:"âœ… Override desactivado",description:"Se volverÃ¡ a usar la sugerencia automÃ¡tica"})}catch(m){throw console.error("Error deactivating override:",m),m}},v=t.useCallback(i=>z.find(m=>m.ficha_equipo===i)||null,[z]),o=async i=>{try{const{data:m,error:x}=await N.from("overrides_planes").select("*").eq("ficha_equipo",i).eq("activo",!0).order("created_at",{ascending:!1}).limit(1).single();if(x&&x.code!=="PGRST116")throw x;return m||null}catch(m){return console.error("Error getting override activo:",m),null}},A=t.useCallback(i=>j.filter(m=>m.ficha_equipo===i),[j]),$=t.useCallback(()=>j.filter(i=>i.activo).length,[j]);return{overrides:j,equiposConOverride:z,loading:P,crearOverride:p,actualizarOverride:F,desactivarOverride:k,verificarOverride:v,getOverrideActivo:o,getHistorialOverrides:A,contarOverridesActivos:$,refreshOverrides:b,refreshEquiposOverride:C,refreshAll:async()=>{w(!0),await Promise.all([b(),C()]),w(!1)}}}function us({equipos:j,equipoSeleccionado:_,onSelectEquipo:z,planActual:B,mpSugerido:P,planesSugeridos:w,onSeleccionarPlan:g,onAsignarMPManual:b,planManualOverride:C}){const[p,F]=t.useState(""),k=t.useMemo(()=>({total:j.length,conPlan:j.filter(o=>C[o.ficha]).length,sinPlan:j.filter(o=>!C[o.ficha]).length}),[j,C]),v=j.filter(o=>o.nombre.toLowerCase().includes(p.toLowerCase())||o.ficha.toLowerCase().includes(p.toLowerCase()));return _?e.jsx(De,{title:_.ficha,headerActions:e.jsx(L,{variant:"ghost",size:"icon",className:"h-9 w-9 rounded-full hover:bg-primary/10 active:scale-90 transition-all",onClick:()=>z(null),children:e.jsx(cs,{className:"h-5 w-5"})}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(ae,{variant:"glass",className:"p-4 border-primary/20 shadow-premium relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-full blur-3xl"}),e.jsxs("div",{className:"relative space-y-3",children:[e.jsx("h3",{className:"font-bold text-lg text-foreground/90",children:_.nombre}),e.jsxs("div",{className:"flex gap-2 text-sm text-muted-foreground flex-wrap",children:[e.jsx(h,{variant:"outline",className:"glass-panel border-primary/20",children:_.categoria}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ke,{className:"h-3 w-3"}),_.modelo]})]})]})]}),P&&e.jsxs(ae,{variant:"glass",className:O("p-4 border-l-4 shadow-premium",P.esManual?"border-l-amber-500 bg-amber-500/5":"border-l-green-500 bg-green-500/5"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:O("p-3 rounded-xl shadow-lg",P.esManual?"bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400":"bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400"),children:e.jsx(oe,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-3xl font-bold bg-gradient-premium bg-clip-text text-transparent",children:P.mp}),e.jsx("p",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-1",children:P.esManual?e.jsxs(e.Fragment,{children:[e.jsx(rs,{className:"h-3 w-3"}),"Manual"]}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-3 w-3"}),"Sugerido"]})})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-lg font-bold text-foreground",children:[P.horasActuales," hrs"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Actuales"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"glass-panel bg-muted/50 p-3 rounded-lg border border-border/30",children:e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed",children:P.razon})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground uppercase tracking-wider",children:"SelecciÃ³n manual"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:["PM1","PM2","PM3","PM4"].map(o=>e.jsx(L,{variant:P.mp===o?"default":"outline",size:"sm",className:O("w-full text-sm font-semibold transition-all active:scale-95",P.mp===o&&"bg-gradient-premium shadow-glow-primary"),onClick:()=>b(o),children:o},o))})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-muted-foreground px-1 uppercase tracking-wider",children:"Planes Disponibles"}),e.jsx("div",{className:"space-y-2",children:w.map(({plan:o,score:A,razon:$},f)=>e.jsxs(ae,{variant:"glass",className:O("p-4 cursor-pointer transition-all duration-300 active:scale-[0.98] border-2 animate-slide-in-up fill-mode-backwards",C[_.ficha]===o.id?"border-primary bg-primary/5 shadow-glow-primary":"border-transparent hover:border-primary/20 hover:shadow-premium"),onClick:()=>g(o.id),style:{animationDelay:`${f*.05}s`},children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-sm text-foreground/90 mb-1",children:o.nombre}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:$})]}),e.jsxs(h,{variant:A>80?"default":"secondary",className:O("text-[0.65rem] ml-2 shadow-sm",A>80&&"bg-gradient-premium border-0"),children:[A,"% Match"]})]}),C[_.ficha]===o.id&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-primary font-semibold animate-fade-in",children:[e.jsx(ne,{className:"h-3.5 w-3.5"}),"Plan Seleccionado"]})]},o.id))})]})]})}):e.jsx(De,{title:"Planificador Inteligente",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs(ae,{variant:"glass",className:"p-3 text-center shadow-premium relative overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-primary/5 group-hover:bg-primary/10 transition-colors"}),e.jsx("p",{className:"text-2xl font-bold text-primary relative z-10",children:k.total}),e.jsx("p",{className:"text-[0.65rem] uppercase tracking-wider text-muted-foreground font-medium relative z-10",children:"Total"})]}),e.jsxs(ae,{variant:"glass",className:"p-3 text-center shadow-premium relative overflow-hidden group border-green-500/20",children:[e.jsx("div",{className:"absolute inset-0 bg-green-500/5 group-hover:bg-green-500/10 transition-colors"}),e.jsx("p",{className:"text-2xl font-bold text-green-600 relative z-10",children:k.conPlan}),e.jsx("p",{className:"text-[0.65rem] uppercase tracking-wider text-green-600/80 font-medium relative z-10",children:"Con Plan"})]}),e.jsxs(ae,{variant:"glass",className:"p-3 text-center shadow-premium relative overflow-hidden group border-amber-500/20",children:[e.jsx("div",{className:"absolute inset-0 bg-amber-500/5 group-hover:bg-amber-500/10 transition-colors"}),e.jsx("p",{className:"text-2xl font-bold text-amber-600 relative z-10",children:k.sinPlan}),e.jsx("p",{className:"text-[0.65rem] uppercase tracking-wider text-amber-600/80 font-medium relative z-10",children:"Sin Plan"})]})]}),e.jsx("div",{className:"sticky top-0 z-10 -mx-4 px-4 py-2 bg-background/80 backdrop-blur-md supports-[backdrop-filter]:bg-background/60",children:e.jsxs("div",{className:"relative group",children:[e.jsx("div",{className:"absolute -inset-0.5 bg-gradient-to-r from-primary/50 to-primary-light/50 rounded-xl blur opacity-20 group-hover:opacity-40 transition duration-500"}),e.jsxs("div",{className:"relative flex items-center bg-card rounded-xl shadow-sm border border-border/50",children:[e.jsx(ce,{className:"ml-3 h-4 w-4 text-muted-foreground"}),e.jsx(Me,{placeholder:"Buscar equipo...",className:"border-0 bg-transparent focus-visible:ring-0 focus-visible:ring-offset-0 placeholder:text-muted-foreground/70 h-11",value:p,onChange:o=>F(o.target.value)})]})]})}),v.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center animate-fade-in",children:[e.jsx("div",{className:"h-24 w-24 rounded-full bg-primary/5 flex items-center justify-center mb-4",children:e.jsx(oe,{className:"h-10 w-10 text-primary/40"})}),e.jsx("p",{className:"text-lg font-semibold text-foreground/80",children:"No se encontraron equipos"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground max-w-[250px]",children:p?"Intenta ajustar tu bÃºsqueda":"No hay equipos disponibles"})]}):e.jsx("div",{className:"space-y-2 pb-24",children:v.map((o,A)=>e.jsx(ae,{variant:"glass",className:"p-4 cursor-pointer transition-all duration-300 hover:shadow-premium active:scale-[0.98] border border-border/40 animate-slide-in-up fill-mode-backwards",style:{animationDelay:`${A*.05}s`},onClick:()=>z(o.ficha),children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-sm text-foreground/90 truncate",children:o.nombre}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 font-mono",children:o.ficha})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[e.jsx(h,{variant:"outline",className:"text-[0.6rem] whitespace-nowrap glass-panel border-primary/20",children:o.categoria}),C[o.ficha]&&e.jsx(ne,{className:"h-4 w-4 text-green-500 flex-shrink-0"})]})]})},o.id))}),p&&e.jsx("div",{className:"fixed bottom-24 left-1/2 -translate-x-1/2 z-40 animate-scale-in",children:e.jsxs("div",{className:"rounded-full bg-foreground/90 px-4 py-2 text-xs font-medium text-background shadow-xl backdrop-blur flex items-center gap-2",children:[e.jsx(ce,{className:"h-3 w-3"}),v.length," resultado",v.length!==1&&"s"]})})]})})}function qs(){var Ee;const{data:j,loading:_}=Ie(),{planes:z,loading:B}=He();es();const{toast:P}=Pe(),{overrides:w,crearOverride:g}=xs(),[b,C]=t.useState(null),[p,F]=t.useState(""),[k,v]=t.useState("all"),[o,A]=t.useState({}),[$,f]=t.useState(!1),[i,m]=t.useState(""),[x,y]=t.useState(!1),[M,D]=t.useState(""),[G,de]=t.useState(""),[me,pe]=t.useState({}),[c,l]=t.useState(!1),[u,X]=t.useState(null),[re,Y]=t.useState(!1),n=t.useMemo(()=>j.equipos.find(s=>s.ficha===b),[j.equipos,b]),xe=t.useMemo(()=>{let s=j.equipos;if(p){const a=p.toLowerCase();s=s.filter(r=>{var R;return r.ficha.toLowerCase().includes(a)||r.nombre.toLowerCase().includes(a)||((R=r.modelo)==null?void 0:R.toLowerCase().includes(a))})}return k!=="all"&&(s=s.filter(a=>a.categoria===k)),s},[j.equipos,p,k]),Be=t.useMemo(()=>{const s=new Set(j.equipos.map(a=>a.categoria));return Array.from(s).filter(Boolean).sort()},[j.equipos]),Ge=(s,a)=>{let r=0;return s.modelo&&a.modelo&&s.modelo.toLowerCase()===a.modelo.toLowerCase()&&(r+=50),s.marca&&a.marca&&s.marca.toLowerCase()===a.marca.toLowerCase()&&(r+=30),s.categoria&&a.categoria&&s.categoria.toLowerCase()===a.categoria.toLowerCase()&&(r+=20),r},J=t.useMemo(()=>!n||B?[]:z.map(a=>({plan:a,score:Ge(a,n),razon:(()=>{var R,I,H,S,le,Se;const r=[];return((R=a.modelo)==null?void 0:R.toLowerCase())===((I=n.modelo)==null?void 0:I.toLowerCase())&&r.push("Modelo exacto"),((H=a.marca)==null?void 0:H.toLowerCase())===((S=n.marca)==null?void 0:S.toLowerCase())&&r.push("Marca coincide"),((le=a.categoria)==null?void 0:le.toLowerCase())===((Se=n.categoria)==null?void 0:Se.toLowerCase())&&r.push("CategorÃ­a coincide"),r.length>0?r.join(" â€¢ "):"GenÃ©rico"})()})).filter(a=>a.score>0).sort((a,r)=>r.score-a.score),[n,z,B]),E=t.useMemo(()=>{var a;if(!n)return null;const s=o[n.ficha];return s?z.find(r=>r.id===s):((a=J[0])==null?void 0:a.plan)||null},[n,o,z,J]),V=t.useMemo(()=>n&&j.mantenimientosRealizados.filter(a=>a.ficha===n.ficha).sort((a,r)=>new Date(r.fechaMantenimiento).getTime()-new Date(a.fechaMantenimiento).getTime())[0]||null,[n,j.mantenimientosRealizados]),q=t.useMemo(()=>n&&j.mantenimientosProgramados.find(s=>s.ficha===n.ficha)||null,[n,j.mantenimientosProgramados]),d=t.useMemo(()=>{if(!n||!q)return null;const s=q.horasKmActuales,a=(V==null?void 0:V.horasKmAlMomento)||q.horasKmUltimoMantenimiento,r=s-a,R=me[n.ficha];if(R)return{mp:R,horasObjetivo:{PM1:250,PM2:500,PM3:1e3,PM4:2e3}[R]||250,horasTranscurridas:r,horasActuales:s,horasUltimoMant:a,razon:`MP asignado manualmente (${r.toFixed(1)}h desde Ãºltimo)`,esManual:!0};let I="PM1",H=250,S="Mantenimiento preventivo regular";return r>=2e3?(I="PM4",H=2e3,S=`Han transcurrido ${r.toFixed(1)}h desde el Ãºltimo mantenimiento mayor`):r>=1e3?(I="PM3",H=1e3,S=`Han transcurrido ${r.toLocaleString()}h desde el Ãºltimo mantenimiento`):r>=500?(I="PM2",H=500,S=`Han transcurrido ${r.toLocaleString()}h desde el Ãºltimo mantenimiento`):S=`Mantenimiento regular cada 250h (${r.toFixed(1)}h desde Ãºltimo)`,{mp:I,horasObjetivo:H,horasTranscurridas:r,horasActuales:s,horasUltimoMant:a,razon:S,esManual:!1}},[n,q,V,me]),{rutas:ke,estadisticas:ue}=ms(b||"",(E==null?void 0:E.id)||null),Q=t.useMemo(()=>{if(!E||!E.intervalos)return[];const s=[];return E.intervalos.forEach(a=>{a.kits&&a.kits.length>0&&a.kits.forEach(r=>{r.kit&&s.push({...r.kit,intervaloMP:a.codigo,intervaloNombre:a.nombre,intervaloHoras:a.horas_intervalo})})}),s},[E]),T=t.useMemo(()=>!d||!Q.length?null:Q.find(a=>{var r;return a.intervaloMP===d.mp||((r=a.intervaloNombre)==null?void 0:r.toLowerCase().includes(d.mp.toLowerCase()))})||Q[0],[d,Q]),Ce=s=>{if(!n)return;A(r=>({...r,[n.ficha]:s}));const a=z.find(r=>r.id===s);P({title:"âœ… Plan seleccionado",description:`Usando: ${a==null?void 0:a.nombre}`})},Ue=async()=>{var s,a;if(!(!n||!E))try{await g({ficha_equipo:n.ficha,plan_original_id:((a=(s=J[0])==null?void 0:s.plan)==null?void 0:a.id)||null,plan_forzado_id:E.id,motivo:i,usuario_email:"admin@alito.com"}),P({title:"âœ… Override guardado",description:"El plan manual ha sido registrado en el sistema"}),f(!1),m("")}catch{P({title:"âŒ Error",description:"No se pudo guardar el override",variant:"destructive"})}},_e=()=>{!n||!M||(pe(s=>({...s,[n.ficha]:M})),P({title:"âœ… MP Asignado",description:`Se asignÃ³ ${M} para el equipo ${n.ficha}. Las rutas se han replanificado.`}),y(!1),D(""),de(""))},Ae=async s=>{try{const{data:a,error:r}=await N.from("kit_piezas").select("*").eq("kit_id",s.id).order("tipo");if(r)throw r;X({...s,piezas:a||[]}),l(!0)}catch{P({title:"âŒ Error",description:"No se pudieron cargar las piezas del kit",variant:"destructive"})}},{isMobile:Ve}=as();return Ve?e.jsx(us,{equipos:xe,equipoSeleccionado:n,onSelectEquipo:C,planActual:E,mpSugerido:d,planesSugeridos:J,onSeleccionarPlan:Ce,onAsignarMPManual:s=>{D(s),_e()},planManualOverride:o}):e.jsxs(Xe,{title:"Planificador Inteligente",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(K,{className:"border-2 border-primary/20 bg-gradient-to-r from-primary/5 via-primary/3 to-transparent",children:e.jsx(Z,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-xl bg-primary/15",children:e.jsx(Ye,{className:"h-8 w-8 text-primary"})}),e.jsxs("div",{children:[e.jsx(ee,{className:"text-2xl",children:"Planificador Inteligente"}),e.jsx(se,{className:"text-base",children:"Sistema de sugerencias automÃ¡ticas y rutas predictivas"})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-primary",children:j.equipos.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Equipos"})]}),e.jsx(ge,{orientation:"vertical",className:"h-12"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-green-600",children:z.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Planes"})]}),e.jsx(ge,{orientation:"vertical",className:"h-12"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-blue-600",children:w.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Overrides"})]})]})]})})}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-[380px,1fr]",children:[e.jsxs(K,{className:"h-fit",children:[e.jsx(Z,{children:e.jsxs(ee,{className:"text-lg flex items-center gap-2",children:[e.jsx(ce,{className:"h-5 w-5 text-primary"}),"Seleccionar Equipo",e.jsx(h,{variant:"secondary",className:"ml-auto",children:xe.length})]})}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"absolute left-3 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(Me,{placeholder:"Buscar equipo...",value:p,onChange:s=>F(s.target.value),className:"pl-9"})]}),e.jsxs(ze,{value:k,onValueChange:v,children:[e.jsxs(Re,{children:[e.jsx(ts,{className:"h-4 w-4 mr-2"}),e.jsx(qe,{placeholder:"CategorÃ­a"})]}),e.jsxs(Le,{children:[e.jsx(ie,{value:"all",children:"Todas las categorÃ­as"}),Be.map(s=>e.jsx(ie,{value:s,children:s},s))]})]}),e.jsx(ge,{}),e.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto",children:_?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(We,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):xe.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ce,{className:"h-12 w-12 mx-auto mb-2 opacity-20"}),e.jsx("p",{className:"text-sm",children:"No se encontraron equipos"})]}):xe.map(s=>e.jsx("button",{onClick:()=>C(s.ficha),className:O("w-full text-left p-3 rounded-lg border-2 transition-all",b===s.ficha?"border-primary bg-primary/5 shadow-md":"border-border hover:border-primary/50 hover:bg-muted/50"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-sm",children:s.nombre}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(h,{variant:"outline",className:"text-xs",children:s.ficha}),e.jsx(h,{variant:"secondary",className:"text-xs",children:s.categoria})]}),s.modelo&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.modelo})]}),e.jsx(Te,{className:O("h-5 w-5 transition-transform",b===s.ficha?"text-primary rotate-0":"text-muted-foreground -rotate-90")})]})},s.ficha))})]})]}),e.jsx("div",{className:"space-y-6",children:b?e.jsxs(e.Fragment,{children:[e.jsxs(K,{children:[e.jsx(Z,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs(ee,{className:"flex items-center gap-2",children:[e.jsx(ns,{className:"h-5 w-5 text-primary"}),n==null?void 0:n.nombre]}),e.jsxs(se,{className:"mt-1",children:[n==null?void 0:n.ficha," â€¢ ",n==null?void 0:n.modelo," â€¢ ",n==null?void 0:n.categoria]})]}),e.jsx(L,{variant:"ghost",size:"sm",onClick:()=>C(null),children:e.jsx(Oe,{className:"h-4 w-4"})})]})}),E&&e.jsx(U,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"default",className:"text-sm",children:["Plan actual: ",E.nombre]}),o[n.ficha]&&e.jsx(h,{variant:"outline",className:"text-xs",children:"Manual"})]})})]}),d&&e.jsx(K,{className:"border-2 border-primary bg-gradient-to-r from-primary/5 via-primary/3 to-transparent",children:e.jsx(U,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:O("p-4 rounded-xl",d.esManual?"bg-amber-100 dark:bg-amber-950":"bg-green-100 dark:bg-green-950"),children:e.jsx(Je,{className:O("h-8 w-8",d.esManual?"text-amber-600":"text-green-600")})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:d.esManual?"ðŸ”§ MP Asignado Manualmente":"ðŸ¤– MP Planificado AutomÃ¡tico"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(h,{className:O("text-3xl py-2 px-6",d.esManual?"bg-amber-600 hover:bg-amber-700":"bg-green-600 hover:bg-green-700"),children:d.mp}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"PrÃ³ximo en"}),e.jsxs("p",{className:O("text-xl font-bold",((q==null?void 0:q.horasKmRestante)||0)>0?"text-orange-600":"text-red-600"),children:[q==null?void 0:q.horasKmRestante.toFixed(1),"h"]})]})]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Horas Actuales"}),e.jsxs("p",{className:"text-2xl font-bold",children:[d.horasActuales.toLocaleString(),"h"]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:[d.horasTranscurridas.toLocaleString(),"h desde Ãºltimo"]})]})]})})}),J.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(L,{variant:"outline",className:"w-full justify-between",onClick:()=>Y(!re),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{children:"Planes Recomendados"}),e.jsx(h,{variant:"secondary",className:"text-xs",children:J.length})]}),e.jsx(Te,{className:O("h-4 w-4 transition-transform",re&&"rotate-90")})]}),re&&e.jsxs(K,{className:"border-2 border-blue-200 dark:border-blue-800",children:[e.jsx(Z,{children:e.jsx(se,{children:"Basado en anÃ¡lisis de similitud de modelo/marca/categorÃ­a"})}),e.jsxs(U,{className:"space-y-3",children:[J.slice(0,3).map(({plan:s,score:a,razon:r})=>{var R;return e.jsx("div",{className:O("p-4 rounded-lg border-2 cursor-pointer transition-all",o[n.ficha]===s.id?"border-primary bg-primary/5":"border-border hover:border-primary/50 hover:bg-muted/50"),onClick:()=>Ce(s.id),children:e.jsx("div",{className:"flex items-start justify-between gap-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs(h,{variant:a>=70?"default":"secondary",className:"text-xs font-bold",children:[a,"% match"]}),o[n.ficha]===s.id&&e.jsx(ne,{className:"h-4 w-4 text-primary"})]}),e.jsx("p",{className:"font-semibold text-sm",children:s.nombre}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.marca," ",s.modelo&&`â€¢ ${s.modelo}`," â€¢ ",r]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs(h,{variant:"outline",className:"text-xs",children:[((R=s.intervalos)==null?void 0:R.length)||0," intervalos"]}),s.categoria&&e.jsx(h,{variant:"outline",className:"text-xs",children:s.categoria})]})]})})},s.id)}),o[n.ficha]&&e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(L,{size:"sm",variant:"outline",className:"flex-1",onClick:()=>{const s={...o};delete s[n.ficha],A(s)},children:"Restaurar automÃ¡tico"}),e.jsx(L,{size:"sm",onClick:()=>f(!0),children:"Guardar override"})]})]})]})]}),d&&q&&e.jsxs(K,{className:O("border-2",d.esManual?"border-amber-200 dark:border-amber-800":"border-green-200 dark:border-green-800"),children:[e.jsx(Z,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs(ee,{className:"text-lg flex items-center gap-2",children:[e.jsx(oe,{className:O("h-5 w-5",d.esManual?"text-amber-600":"text-green-600")}),d.esManual?"MP Asignado Manualmente":"MP Sugerido SegÃºn Ãšltimo Mantenimiento",d.esManual&&e.jsx(h,{variant:"outline",className:"bg-amber-100 text-amber-800 dark:bg-amber-950 dark:text-amber-200",children:"Manual"})]}),e.jsxs(se,{className:"mt-1",children:["Basado en ",d.horasTranscurridas.toFixed(1),"h desde el Ãºltimo mantenimiento"]})]}),e.jsxs("div",{className:"flex gap-2",children:[d.esManual&&e.jsxs(L,{size:"sm",variant:"outline",onClick:()=>{const s={...me};delete s[n.ficha],pe(s),P({title:"âœ… MP Restaurado",description:"Se restaurÃ³ la sugerencia automÃ¡tica"})},children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),"Restaurar Auto"]}),e.jsxs(L,{size:"sm",variant:"outline",onClick:()=>y(!0),children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),d.esManual?"Cambiar":"Asignar Manual"]})]})]})}),e.jsxs(U,{className:"space-y-4",children:[e.jsx("div",{className:O("flex items-center justify-center p-6 rounded-xl border-2",d.esManual?"bg-gradient-to-r from-amber-50 via-amber-100 to-amber-50 dark:from-amber-950/40 dark:via-amber-900/20 dark:to-amber-950/40 border-amber-300 dark:border-amber-700":"bg-gradient-to-r from-green-50 via-green-100 to-green-50 dark:from-green-950/40 dark:via-green-900/20 dark:to-green-950/40 border-green-300 dark:border-green-700"),children:e.jsxs("div",{className:"text-center",children:[e.jsx(h,{className:O("text-2xl py-2 px-6",d.esManual?"bg-amber-600 hover:bg-amber-700":"bg-green-600 hover:bg-green-700"),children:d.mp}),e.jsx("p",{className:"text-sm text-muted-foreground mt-3",children:d.razon})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Horas Actuales"}),e.jsxs("p",{className:"text-xl font-bold",children:[d.horasActuales.toFixed(1),"h"]})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ãšltimo Mantenimiento"}),e.jsxs("p",{className:"text-xl font-bold",children:[d.horasUltimoMant.toFixed(1),"h"]})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Horas Transcurridas"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:[d.horasTranscurridas.toFixed(1),"h"]})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"PrÃ³ximo MP en"}),e.jsx("p",{className:O("text-xl font-bold",q.horasKmRestante>0?"text-orange-600":"text-red-600"),children:q.horasKmRestante>0?`${q.horasKmRestante.toFixed(1)}h`:`${q.horasKmRestante.toFixed(1)}h`})]})]}),V&&e.jsx("div",{className:"p-4 bg-blue-50 dark:bg-blue-950/20 rounded-lg border border-blue-200 dark:border-blue-800",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ls,{className:"h-5 w-5 text-blue-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-sm text-blue-900 dark:text-blue-100",children:"Ãšltimo Mantenimiento Realizado"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Fecha:"})," ",e.jsx("span",{className:"font-medium",children:os(new Date(V.fechaMantenimiento),"dd MMM yyyy",{locale:Qe})})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Horas:"})," ",e.jsxs("span",{className:"font-medium",children:[V.horasKmAlMomento.toFixed(1),"h"]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Observaciones:"})," ",e.jsx("span",{className:"font-medium",children:V.observaciones||"Sin observaciones"})]})]})]})]})})]})]}),!E&&e.jsxs(K,{className:"border-2 border-amber-200 dark:border-amber-800 bg-amber-50/50 dark:bg-amber-950/20",children:[e.jsxs(Z,{children:[e.jsxs(ee,{className:"text-lg flex items-center gap-2 text-amber-900 dark:text-amber-100",children:[e.jsx(te,{className:"h-5 w-5 text-amber-600"}),"Sin Plan Asignado"]}),e.jsx(se,{children:"Este equipo no tiene un plan de mantenimiento asignado"})]}),e.jsx(U,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Los equipos que no son Caterpillar o no tienen planes especÃ­ficos asignados no cuentan con:"}),e.jsxs("ul",{className:"space-y-2 text-sm",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 mt-0.5",children:"â€¢"}),e.jsx("span",{children:"Rutas predictivas de mantenimiento"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 mt-0.5",children:"â€¢"}),e.jsx("span",{children:"Kits de repuestos asociados"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-amber-600 mt-0.5",children:"â€¢"}),e.jsx("span",{children:"Intervalos de mantenimiento predefinidos"})]})]}),e.jsx("div",{className:"mt-4 p-3 bg-white dark:bg-slate-900 rounded-lg border border-amber-200 dark:border-amber-800",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:[e.jsx("strong",{children:"Sugerencia:"})," Puedes asignar un plan manualmente desde el mÃ³dulo de Planes de Mantenimiento"]})})]})})]}),E&&Q.length>0&&e.jsxs(K,{className:"border-2 border-purple-200 dark:border-purple-800",children:[e.jsxs(Z,{children:[e.jsxs(ee,{className:"text-lg flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5 text-purple-600"}),"Kits de Mantenimiento del Plan",e.jsxs(h,{variant:"secondary",className:"ml-auto",children:[Q.length," kits"]})]}),e.jsx(se,{children:"Kits asociados a los intervalos de este plan"})]}),e.jsxs(U,{className:"space-y-3",children:[T&&d&&e.jsx("div",{className:"p-4 bg-gradient-to-r from-purple-50 via-purple-100 to-purple-50 dark:from-purple-950/40 dark:via-purple-900/20 dark:to-purple-950/40 rounded-xl border-2 border-purple-300 dark:border-purple-700 mb-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx(Fe,{className:"h-5 w-5 text-purple-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-semibold text-sm text-purple-900 dark:text-purple-100 mb-2",children:["Kit Recomendado para ",d.mp]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{className:"bg-purple-600",children:T.codigo}),e.jsx(h,{variant:"outline",children:T.intervaloMP}),e.jsxs(h,{variant:"secondary",children:[T.intervaloHoras,"h"]})]}),e.jsx("p",{className:"text-sm font-medium",children:T.nombre}),T.descripcion&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:T.descripcion})]})]}),e.jsxs(L,{size:"sm",variant:"outline",onClick:()=>Ae(T),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Ver Detalle"]})]})}),e.jsx(fe,{className:"h-[300px] pr-4",children:e.jsx("div",{className:"space-y-2",children:Q.map(s=>e.jsx("div",{className:O("p-3 rounded-lg border-2 transition-all",(T==null?void 0:T.id)===s.id?"border-purple-400 bg-purple-50 dark:bg-purple-950/30":"border-border hover:border-purple-200 hover:bg-muted/50"),children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(h,{variant:"secondary",className:"text-xs",children:s.codigo}),e.jsx(h,{variant:"outline",className:"text-xs",children:s.intervaloMP}),e.jsxs(h,{variant:"outline",className:"text-xs",children:[s.intervaloHoras,"h"]}),(T==null?void 0:T.id)===s.id&&e.jsx(h,{className:"text-xs bg-purple-600",children:"Recomendado"})]}),e.jsx("p",{className:"font-semibold text-sm",children:s.nombre}),s.descripcion&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.descripcion}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[s.marca&&e.jsx(h,{variant:"outline",className:"text-xs",children:s.marca}),s.modelo_aplicable&&e.jsx(h,{variant:"outline",className:"text-xs",children:s.modelo_aplicable})]})]}),e.jsx(L,{size:"sm",variant:"ghost",onClick:()=>Ae(s),children:e.jsx(te,{className:"h-4 w-4"})})]})},s.id))})})]})]}),ke.length>0&&e.jsxs(K,{children:[e.jsxs(Z,{children:[e.jsxs(ee,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ke,{className:"h-5 w-5 text-green-600"}),"PrÃ³ximas 8 Rutas Predictivas",(d==null?void 0:d.esManual)&&e.jsx(h,{variant:"outline",className:"bg-amber-100 text-amber-800 dark:bg-amber-950 dark:text-amber-200",children:"Replanificadas"})]}),e.jsx(se,{children:d!=null&&d.esManual?`Rutas replanificadas automÃ¡ticamente basadas en ${d.mp} asignado manualmente`:"Generadas automÃ¡ticamente basadas en el plan actual"})]}),e.jsxs(U,{className:"space-y-4",children:[(d==null?void 0:d.esManual)&&e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-50 dark:bg-amber-950/20 rounded-lg border border-amber-200 dark:border-amber-800 mb-4",children:[e.jsx(te,{className:"h-4 w-4 text-amber-600 mt-0.5 flex-shrink-0"}),e.jsxs("p",{className:"text-xs text-amber-800 dark:text-amber-200",children:["Las rutas han sido recalculadas automÃ¡ticamente considerando el MP ",d.mp," asignado manualmente. Los siguientes mantenimientos estÃ¡n planificados en base a esta decisiÃ³n."]})]}),e.jsx(fe,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-3 pr-4",children:ke.map((s,a)=>{var I,H;const r=(I=E==null?void 0:E.intervalos)==null?void 0:I.find(S=>S.codigo===s.mp||S.nombre.includes(s.mp)),R=((H=r==null?void 0:r.kits)==null?void 0:H.map(S=>S.kit))||[];return e.jsxs("div",{className:"p-4 rounded-lg border-2 border-border hover:border-primary/50 transition-all",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(h,{className:"bg-gradient-to-r from-green-600 to-green-700 text-lg px-3 py-1",children:s.mp}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-semibold text-sm",children:["Ruta #",s.orden," â€¢ Ciclo ",s.ciclo]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.horasObjetivo.toFixed(1),"h objetivo"]})]})]}),a===0&&e.jsx(h,{variant:"secondary",className:"bg-orange-100 text-orange-800 dark:bg-orange-950 dark:text-orange-200",children:"PrÃ³ximo"})]}),r&&r.tareas&&r.tareas.length>0&&e.jsxs("div",{className:"mb-3 p-3 bg-blue-50 dark:bg-blue-950/20 rounded-lg border border-blue-200 dark:border-blue-800",children:[e.jsxs("p",{className:"text-xs font-semibold text-blue-900 dark:text-blue-100 mb-2 flex items-center gap-2",children:[e.jsx(oe,{className:"h-3 w-3"}),"Tareas Programadas (",r.tareas.length,")"]}),e.jsxs("ul",{className:"space-y-1",children:[r.tareas.slice(0,5).map((S,le)=>e.jsxs("li",{className:"text-xs text-muted-foreground flex items-start gap-2",children:[e.jsx(ne,{className:"h-3 w-3 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:S})]},le)),r.tareas.length>5&&e.jsxs("li",{className:"text-xs text-muted-foreground italic",children:["+ ",r.tareas.length-5," tareas mÃ¡s..."]})]})]}),R.length>0&&e.jsxs("div",{className:"p-3 bg-purple-50 dark:bg-purple-950/20 rounded-lg border border-purple-200 dark:border-purple-800",children:[e.jsxs("p",{className:"text-xs font-semibold text-purple-900 dark:text-purple-100 mb-2 flex items-center gap-2",children:[e.jsx(he,{className:"h-3 w-3"}),"Kits Requeridos (",R.length,")"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:R.map(S=>e.jsxs(h,{variant:"outline",className:"text-xs",children:[S.codigo," - ",S.nombre]},S.id))})]}),!r&&e.jsx("div",{className:"p-2 bg-muted/50 rounded text-xs text-muted-foreground text-center",children:"Intervalo sin configuraciÃ³n de tareas"})]},a)})})}),ue&&e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-4 p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Rutas"}),e.jsx("p",{className:"text-2xl font-bold",children:ue.totalRutas})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ciclos Completos"}),e.jsx("p",{className:"text-2xl font-bold",children:ue.totalCiclos})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Horas Totales"}),e.jsxs("p",{className:"text-2xl font-bold",children:[ue.horasTotal.toFixed(1),"h"]})]})]})]})]})]}):e.jsx(K,{children:e.jsxs(U,{className:"p-12 text-center",children:[e.jsx(is,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-20"}),e.jsx("p",{className:"text-lg font-medium text-muted-foreground",children:"Selecciona un equipo para ver su planificaciÃ³n"})]})})})]})]}),e.jsx(je,{open:$,onOpenChange:f,children:e.jsxs(be,{children:[e.jsxs(ve,{children:[e.jsx(Ne,{children:"Guardar Override Manual"}),e.jsx(we,{children:"Registra el motivo de la asignaciÃ³n manual de este plan"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Equipo"}),e.jsx("p",{className:"text-sm font-medium",children:n==null?void 0:n.nombre})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Plan seleccionado"}),e.jsx("p",{className:"text-sm font-medium",children:E==null?void 0:E.nombre})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"motivo",children:"Motivo *"}),e.jsx(Me,{id:"motivo",placeholder:"Ej: Requerimientos especiales del cliente",value:i,onChange:s=>m(s.target.value)})]})]}),e.jsxs(ye,{children:[e.jsx(L,{variant:"outline",onClick:()=>f(!1),children:"Cancelar"}),e.jsx(L,{onClick:Ue,disabled:!i,children:"Guardar Override"})]})]})}),e.jsx(je,{open:x,onOpenChange:y,children:e.jsxs(be,{children:[e.jsxs(ve,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5 text-primary"}),"Asignar MP Manual"]}),e.jsx(we,{children:"Sobrescribe la sugerencia automÃ¡tica y asigna un MP especÃ­fico"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Equipo"}),e.jsxs("p",{className:"text-sm font-medium",children:[n==null?void 0:n.nombre," (",n==null?void 0:n.ficha,")"]})]}),d&&e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx(W,{className:"text-xs text-muted-foreground",children:"MP Sugerido AutomÃ¡tico"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(h,{className:"bg-green-600",children:d.mp}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Basado en ",d.horasTranscurridas.toFixed(1),"h transcurridas"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"mp-manual",children:"MP a Asignar *"}),e.jsxs(ze,{value:M,onValueChange:D,children:[e.jsx(Re,{id:"mp-manual",children:e.jsx(qe,{placeholder:"Selecciona el MP"})}),e.jsxs(Le,{children:[e.jsx(ie,{value:"PM1",children:"PM1 - Mantenimiento Regular (250h)"}),e.jsx(ie,{value:"PM2",children:"PM2 - Mantenimiento Intermedio (500h)"}),e.jsx(ie,{value:"PM3",children:"PM3 - Mantenimiento Mayor (1000h)"}),e.jsx(ie,{value:"PM4",children:"PM4 - Mantenimiento Extenso (2000h)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"observaciones-mp",children:"Observaciones"}),e.jsx(ss,{id:"observaciones-mp",placeholder:"Ej: Cliente solicitÃ³ adelantar el mantenimiento...",value:G,onChange:s=>de(s.target.value),rows:3})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-50 dark:bg-amber-950/20 rounded-lg border border-amber-200 dark:border-amber-800",children:[e.jsx(te,{className:"h-4 w-4 text-amber-600 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-xs text-amber-800 dark:text-amber-200",children:"Esta asignaciÃ³n manual quedarÃ¡ registrada en el sistema para auditorÃ­a. El sistema volverÃ¡ a sugerir automÃ¡ticamente despuÃ©s del prÃ³ximo mantenimiento."})]})]}),e.jsxs(ye,{children:[e.jsx(L,{variant:"outline",onClick:()=>{y(!1),D(""),de("")},children:"Cancelar"}),e.jsxs(L,{onClick:_e,disabled:!M,children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Asignar MP"]})]})]})}),e.jsx(je,{open:c,onOpenChange:l,children:e.jsxs(be,{className:"max-w-3xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(ve,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5 text-purple-600"}),"Detalle del Kit de Mantenimiento"]}),e.jsx(we,{children:"Componentes y piezas incluidas en este kit"})]}),u&&e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("div",{className:"p-4 bg-purple-50 dark:bg-purple-950/20 rounded-lg border border-purple-200 dark:border-purple-800",children:e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(h,{className:"bg-purple-600",children:u.codigo}),e.jsx("h3",{className:"font-semibold text-lg",children:u.nombre})]}),u.descripcion&&e.jsx("p",{className:"text-sm text-muted-foreground",children:u.descripcion})]})})}),e.jsxs("div",{children:[e.jsxs(W,{className:"text-base font-semibold flex items-center gap-2 mb-3",children:[e.jsx(oe,{className:"h-4 w-4"}),"Piezas del Kit (",((Ee=u.piezas)==null?void 0:Ee.length)||0,")"]}),u.piezas&&u.piezas.length>0?e.jsx(fe,{className:"h-[400px] pr-4",children:e.jsx("div",{className:"space-y-2",children:u.piezas.map((s,a)=>e.jsx("div",{className:"p-3 rounded-lg border-2 border-border hover:border-purple-200 hover:bg-muted/50 transition-all",children:e.jsx("div",{className:"flex items-start justify-between gap-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs(h,{variant:"outline",className:"font-mono text-xs",children:["#",a+1]}),e.jsx(h,{variant:"secondary",className:"text-xs",children:s.tipo}),e.jsxs(h,{className:"bg-blue-600 text-xs",children:["x",s.cantidad," ",s.unidad||"unid"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold text-sm",children:s.descripcion}),e.jsxs("p",{className:"text-xs text-muted-foreground font-mono",children:["P/N: ",s.numero_parte]}),s.notas&&e.jsx("div",{className:"mt-2 p-2 bg-amber-50 dark:bg-amber-950/20 rounded border border-amber-200 dark:border-amber-800",children:e.jsxs("p",{className:"text-xs text-amber-800 dark:text-amber-200",children:[e.jsx(te,{className:"h-3 w-3 inline mr-1"}),s.notas]})})]})]})})},s.id))})}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(he,{className:"h-12 w-12 mx-auto mb-2 opacity-20"}),e.jsx("p",{className:"text-sm",children:"No hay piezas registradas en este kit"})]})]}),u.piezas&&u.piezas.length>0&&e.jsx("div",{className:"p-4 bg-muted/50 rounded-lg",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Piezas"}),e.jsx("p",{className:"text-2xl font-bold",children:u.piezas.length})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cantidad Total"}),e.jsx("p",{className:"text-2xl font-bold",children:u.piezas.reduce((s,a)=>s+a.cantidad,0)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Tipos Ãšnicos"}),e.jsx("p",{className:"text-2xl font-bold",children:new Set(u.piezas.map(s=>s.tipo)).size})]})]})})]}),e.jsx(ye,{children:e.jsx(L,{variant:"outline",onClick:()=>{l(!1),X(null)},children:"Cerrar"})})]})})]})}export{qs as default};
