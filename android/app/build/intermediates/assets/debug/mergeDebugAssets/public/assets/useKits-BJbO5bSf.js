import{r as p,l as w,s as l}from"./index-C_D-5Bfv.js";function _(){const[u,c]=p.useState([]),[z,m]=p.useState(!0),{toast:o}=w(),n=p.useCallback(async()=>{try{m(!0);const{data:t,error:e}=await l.from("kits_mantenimiento").select("*, piezas:kit_piezas(*)").order("nombre");if(e)throw e;c(t||[])}catch(t){console.error("Error loading kits:",t),o({title:"Error",description:"No se pudieron cargar los kits de mantenimiento",variant:"destructive"})}finally{m(!1)}},[o]);return p.useEffect(()=>{n();const t=l.channel("kits-changes").on("postgres_changes",{event:"*",schema:"public",table:"kits_mantenimiento"},()=>n()).on("postgres_changes",{event:"*",schema:"public",table:"kit_piezas"},()=>n()).subscribe();return()=>{l.removeChannel(t)}},[n]),{kits:u,loading:z,createKit:async t=>{try{const e={...t,id:-Date.now(),created_at:new Date().toISOString(),piezas:[]};c(i=>[...i,e].sort((a,d)=>a.nombre.localeCompare(d.nombre)));const{data:r,error:s}=await l.from("kits_mantenimiento").insert([t]).select().single();if(s)throw await n(),s;return c(i=>i.map(a=>a.id===e.id?{...r,piezas:[]}:a)),o({title:"Kit creado",description:"El kit de mantenimiento se creó correctamente"}),r}catch(e){throw console.error("Error creating kit:",e),o({title:"Error",description:e.message.includes("duplicate")?"Ya existe un kit con ese código":"No se pudo crear el kit",variant:"destructive"}),e}},updateKit:async(t,e)=>{try{c(s=>s.map(i=>i.id===t?{...i,...e}:i));const{error:r}=await l.from("kits_mantenimiento").update(e).eq("id",t);if(r)throw await n(),r;o({title:"Kit actualizado",description:"El kit se actualizó correctamente"})}catch(r){throw console.error("Error updating kit:",r),o({title:"Error",description:"No se pudo actualizar el kit",variant:"destructive"}),r}},deleteKit:async t=>{try{c(r=>r.filter(s=>s.id!==t));const{error:e}=await l.from("kits_mantenimiento").delete().eq("id",t);if(e)throw await n(),e;o({title:"Kit eliminado",description:"El kit se eliminó correctamente"})}catch(e){throw console.error("Error deleting kit:",e),o({title:"Error",description:"No se pudo eliminar el kit",variant:"destructive"}),e}},createPieza:async t=>{try{const e={...t,id:-Date.now(),created_at:new Date().toISOString()};c(i=>i.map(a=>a.id===t.kit_id?{...a,piezas:[...a.piezas,e]}:a));const{data:r,error:s}=await l.from("kit_piezas").insert([t]).select().single();if(s)throw await n(),s;return c(i=>i.map(a=>({...a,piezas:a.piezas.map(d=>d.id===e.id?r:d)}))),o({title:"Pieza agregada",description:"La pieza se agregó al kit"}),r}catch(e){throw console.error("Error creating piece:",e),o({title:"Error",description:"No se pudo agregar la pieza",variant:"destructive"}),e}},updatePieza:async(t,e)=>{try{c(s=>s.map(i=>({...i,piezas:i.piezas.map(a=>a.id===t?{...a,...e}:a)})));const{error:r}=await l.from("kit_piezas").update(e).eq("id",t);if(r)throw await n(),r;o({title:"Pieza actualizada",description:"La pieza se actualizó correctamente"})}catch(r){throw console.error("Error updating piece:",r),o({title:"Error",description:"No se pudo actualizar la pieza",variant:"destructive"}),r}},deletePieza:async t=>{try{c(r=>r.map(s=>({...s,piezas:s.piezas.filter(i=>i.id!==t)})));const{error:e}=await l.from("kit_piezas").delete().eq("id",t);if(e)throw await n(),e;o({title:"Pieza eliminada",description:"La pieza se eliminó del kit"})}catch(e){throw console.error("Error deleting piece:",e),o({title:"Error",description:"No se pudo eliminar la pieza",variant:"destructive"}),e}},refreshKits:n}}export{_ as u};
